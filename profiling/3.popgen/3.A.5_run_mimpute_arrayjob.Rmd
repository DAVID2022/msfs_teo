---
title: "Step5: run array job for NA imputation"
output: html_notebook
author: Jinliang Yang
date: 12-12-2018
---


```{r setup, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE) 
knitr::opts_knit$set(root.dir=normalizePath('../../')) 
#library(tidyverse)
```

## Step4 and Step5: 


### Test
```{r}
library(data.table)
mx <- fread("largedata/mr_100bp/teosinte_CpG_matrix.csv", data.table=FALSE)
out <- doimpute(mx, ncols=2:21, binsize=1000)

out <- doimpute(mx, ncols=2:3, binsize=1000)

mx <- fread("largedata/mr_100bp/landrace_CpG_matrix.csv", data.table=FALSE)
out <- doimpute(mx, ncols=2:18, binsize=1000)

mx <- fread("largedata/mr_100bp/elite_CpG_matrix.csv", data.table=FALSE)
out <- doimpute(mx, ncols=2:17, binsize=1000)

```


### Teosinte
```{r}
library("huskeR")
run_Rcode(inputdf=data.frame(file=1:3, out=10), outdir="slurm-script", cmdno = 1, 
           rcodes = "profiling/3.popgen/3.A.4_setup_ajob_teo.R",
           arrayshid = "slurm-script/run_rcode_array.sh",
           email="yangjl0930@gmail.com", 
            runinfo = c(TRUE, "jclarke", 10, "30G", "16:00:00"))
#
```

### Landrace
```{r}
library("huskeR")
run_Rcode(inputdf=data.frame(file=1:3, out=10), outdir="slurm-script", cmdno = 1, 
           rcodes = "profiling/3.popgen/3.A.4_setup_ajob_land.R",
           arrayshid = "slurm-script/run_land_array.sh",
           email="yangjl0930@gmail.com", 
            runinfo = c(TRUE, "jclarke", 10, "30G", "24:00:00"))
#
```

### Maize
```{r}
library("huskeR")
run_Rcode(inputdf=data.frame(file=1:3, out=10), outdir="slurm-script", cmdno = 1, 
           rcodes = "profiling/3.popgen/3.A.4_setup_ajob_maize.R",
           arrayshid = "slurm-script/run_maize_array.sh",
           email="yangjl0930@gmail.com", 
            runinfo = c(TRUE, "jclarke", 10, "50G", "36:00:00"))
#
```


## Missing Data filtering

Note that maize CG could not run successfully because of high missing rate:


```{r, eval=FALSE}

tb <- apply(mx[,-1], 2, function(x) sum(is.na(x)))
tb/nrow(mx)

mx <- mx[, -14:-15]
mx$missing <- apply(mx[,-1], 1, function(x) sum(is.na(x)))
table(mx$missing)

mx2 <- subset(mx, missing < 9 ) #9/15=60%
fwrite(mx2[, -16], "largedata/mr_100bp/elite_rm_CpG_matrix.csv", sep=",", row.names=FALSE, quote=FALSE)


######### CHG
mx <- fread("largedata/mr_100bp/elite_CHG_matrix.csv", data.table=FALSE)
tb <- apply(mx[,-1], 2, function(x) sum(is.na(x)))
tb/nrow(mx)

mx <- mx[, -14:-15]
mx$missing <- apply(mx[,-1], 1, function(x) sum(is.na(x)))
table(mx$missing)

mx2 <- subset(mx, missing < 9 ) #9/15=60%
fwrite(mx2[, -16], "largedata/mr_100bp/elite_rm_CHG_matrix.csv", sep=",", row.names=FALSE, quote=FALSE)

######### CHH
mx <- fread("largedata/mr_100bp/elite_CHH_matrix.csv", data.table=FALSE)
tb <- apply(mx[,-1], 2, function(x) sum(is.na(x)))
tb/nrow(mx)

mx <- mx[, -14:-15]
mx$missing <- apply(mx[,-1], 1, function(x) sum(is.na(x)))
table(mx$missing)

mx2 <- subset(mx, missing < 9 ) #9/15=60%
fwrite(mx2[, -16], "largedata/mr_100bp/elite_rm_CHH_matrix.csv", sep=",", row.names=FALSE, quote=FALSE)

```











