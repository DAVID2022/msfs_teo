---
title: "DMR and HiChIP"
output: html_notebook
author: Jinliang Yang
date: 05-22-2019
---


```{r setup, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE) 
knitr::opts_knit$set(root.dir=normalizePath('../../')) 
#library(tidyverse)
```



## DMR

```{r}
dmr <- read.delim("data/all_DMRs_03052019.txt", header=TRUE)
table(dmr$Compare)

## Teosinte and Maize DMR
tm <- subset(dmr, Compare %in% "Teosinte/Maize")
tm$bp <- abs(tm$stop - tm$start)

hist(log10(tm$bp), breaks = 100, col="#eed5b7", main="DMR ", xlab="log10(bp)")
abline(v=median(log10(tm$bp)), lty=2, lwd=2, col="red")
median(tm$bp) # 315
mean(tm$bp) #436

```

# HiChIP Results


```{r}
hichip <- read.table("data/hichipper_interation.txt", header=TRUE)

sum(hichip$Chr_1 == hichip$Chr_2)
#which(hichip$Chr_1 != hichip$Chr_2)

hichip$len1 <- hichip$E1 - hichip$S1
hichip$len2 <- hichip$E2 - hichip$S2


### The length of the interaction sites
l <- c(hichip$len1, hichip$len2)
hist(log10(l), breaks = 100, col="#eed5b7", main="Length the interaction sites", xlab="Log10(bp)")
abline(v=median(log10(l)), lty=2, lwd=2, col="red")
median(l) 
mean(l)

### The distance of the two interaction sites
hichip$dis <- (hichip$S2 + hichip$E2)/2 - (hichip$S1 + hichip$E1)/2
d <- hichip$dis
hist(log10(d), breaks = 100, col="#eed5b7", main="Distance of the two interaction sites", xlab="Log10(bp)")
abline(v=median(log10(d)), lty=2, lwd=2, col="red")
median(d) 
mean(d)

```



## Final Overalp between DMR and HiChIP

```{r}
library("GenomicRanges")
#library("data.table")
library(plyr)

df1 <- dmr
names(dmr)[4] <- "end"
df2 <- hichip
df2 <- data.frame(chr=c(hichip$Chr_1, hichip$Chr_2), 
                  start=c(hichip$S1, hichip$S2),
                  end=c(hichip$E1, hichip$E2))
df2$id <- paste(df2$chr, df2$start, df2$end, sep="_")

## unique anchors
df2 <- df2[!duplicated(df2$id),]
df2$bp <- df2$end - df2$start
sum(df2$bp)

tb <- table(df2$id)


find_overlaps <- function(df1, df2){
    
    ## df1: chr, start, end, ratio (mehtylation ratio) [data.frame]
    ## df2: chr, start, end
    
    #df$chr <- gsub("Chr", "", df$chr)
    
    gr1 <- with(df1, GRanges(seqnames=chr, IRanges(start=start, end=end)))
    gr2 <- with(df2, GRanges(seqnames=chr, IRanges(start=start, end=end)))
    
    #######
    tb <- findOverlaps(query=gr1, subject=gr2)
    tb <- as.matrix(tb)
    
    out1 <- as.data.frame(grf[tb[,1]])
    out2 <- as.data.frame(grc[tb[,2]])
    
    out <- cbind(out1, out2[, "value"])
    names(out)[8] <- "value"
    
    out$exonid <- paste(out$txid, out$exonid, sep="_")
    
    mtx <- ddply(out, .(txid), summarise,
                 mean = mean(value, na.rm = TRUE),
                 var = var(value, na.rm=TRUE))
    mexon <- ddply(out, .(exonid), summarise,
                 mean = mean(value, na.rm = TRUE),
                 var = var(value, na.rm=TRUE))
    
    myout <- list(mtx, mexon)
    return(myout)
}

```


