---
title: "Run VCAP to seperate rare and common epialleles"
output: NULL
date: 09-29-2020
author: "Jinliang Yang"
---


1. Recoding the methylation data to 0,1,2

```{r}
library(data.table)
meth=fread("/common/jyanglab/shared/Gen_Xu/07-08-2019-mr_100bptile/CG_meth.txt",head=T,data.table=F)
d=meth[,1:3]
for(i in 4:ncol(meth))
{
  meth[which(meth[,i]<0.3),i]=0
  meth[which(meth[,i]>0.7),i]=2
  meth[which(meth[,i]>=0.3 & meth[,i]<=0.7),i]=1
  cat(i,"\n")
}
write.table(meth,file="/common/jyanglab/shared/Gen_Xu/07-08-2019-mr_100bptile/CG_meth_012.txt",row.names = F,col.names = T,sep="\t",quote=F)

```

2. calculate methylation epiallele frequency

```{r}
# methylation epiallele frequency
mef=function(x)
{
  x=which(!is.na(x))
  f0=length(which(x==0))
  f1=length(which(x==1))
  f2=length(which(x==2))
  (f1+2*f2)/(2*length(x)) ###need to check the formula.
}

library("data.table")
meth=fread("/common/jyanglab/shared/Gen_Xu/07-08-2019-mr_100bptile/CG_meth_012.txt", head=T, data.table=F)

meth$mef <- apply(meth[,-c(1:3)], 1, mef)

nrow(meth[meth$mef==0,])
nrow(meth[meth$mef==1,])
nrow(meth[meth$mef==1,])
nrow(meth[meth$mef==1,])

```

3. Convert to bed format

```{r}
## mef ==0, completely unmethylated tiles
fwrite(meth[mef==0, 1:3], file="Completely_unmeth.bed", row.names = F, col.names = T, sep="\t", quote=F)

## mef ==1, completely methylated tiles
fwrite(meth[mef==1, 1:3], file="Completely_meth.bed", row.names = F, col.names = T, sep="\t", quote=F)

## mef > 0.9 or mef < 0.1, rare epialleles
fwrite(meth[mef>0.9 | mef<0.1, 1:3], file="Rare_epi.bed", row.names = F, col.names = T, sep="\t", quote=F)

## mef > 0.1 and mef < 0.8, common epialleles
fwrite(meth[mef>0.1 & mef<0.8, 1:3], file="Common_epi.bed", row.names = F, col.names = F, sep="\t", quote=F)

```


